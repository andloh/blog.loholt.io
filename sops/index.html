<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Encrypt your Kubernetes secrets with Sops, FluxCD and age - blog.loholt.io</title><meta name=Description content="blog.loholt.io"><meta property="og:title" content="Encrypt your Kubernetes secrets with Sops, FluxCD and age"><meta property="og:description" content="Manage your secrets using GitOps and Sops"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost/sops/"><meta property="og:image" content="http://localhost/static/kubernetes.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-15T00:00:00+00:00"><meta property="article:modified_time" content="2022-05-15T00:00:00+00:00"><meta property="og:site_name" content="blog.loholt.io"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost/static/kubernetes.png"><meta name=twitter:title content="Encrypt your Kubernetes secrets with Sops, FluxCD and age"><meta name=twitter:description content="Manage your secrets using GitOps and Sops"><meta name=application-name content="blog.loholt.io"><meta name=apple-mobile-web-app-title content="blog.loholt.io"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://localhost/sops/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Encrypt your Kubernetes secrets with Sops, FluxCD and age","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/localhost\/sops\/"},"genre":"posts","keywords":"Open Source, Secret Management, GitOps, Kubernetes","wordcount":1452,"url":"http:\/\/localhost\/sops\/","datePublished":"2022-05-15T00:00:00+00:00","dateModified":"2022-05-15T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Andreas Loholt"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=blog.loholt.io><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=blog.loholt.io><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Encrypt your Kubernetes secrets with Sops, FluxCD and age</h1><h2 class=single-subtitle>Manage your secrets using GitOps and Sops</h2><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://blog.loholt.io title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Andreas Loholt</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=15-05-2022>15-05-2022</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1452 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/sops-arch.png data-srcset="/images/sops-arch.png, /images/sops-arch.png 1.5x, /images/sops-arch.png 2x" data-sizes=auto alt=/images/sops-arch.png title=/images/sops-arch.png width=1610 height=1092></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#the-problem>The problem</a></li><li><a href=#why-sops>Why sops?</a></li><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#installation>Installation</a></li><li><a href=#why-age>Why Age</a></li><li><a href=#generating-the-private-key>Generating the private key</a></li><li><a href=#encrypt-your-secret-object>Encrypt your secret object</a></li><li><a href=#deploy-your-secret>Deploy your secret</a></li><li><a href=#decrypt-and-edit-your-secret-on-the-fly-for-debugging>Decrypt and edit your secret on the fly for debugging</a></li><li><a href=#encrypt-a-secret-object-with-multiple-keys>Encrypt a secret object with multiple keys</a></li><li><a href=#age-and-sops-configuration>Age and Sops configuration</a><ul><li><a href=#age>Age</a></li><li><a href=#sops>Sops</a></li></ul></li><li><a href=#useful-commands-and-tips>Useful commands and tips</a></li><li><a href=#verdict>Verdict</a><ul><li><a href=#the-good>The good</a></li><li><a href=#the-_not_-so-good>The <em>not</em> so good</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>Manage your secrets using <strong>GitOps</strong> and <strong>Sops</strong></p><h2 id=the-problem>The problem</h2><p>With everything moving to a Gitops based workflow, which is great btw, we need to have a place to <em>store</em> our secrets together with our declarative infrastructure and application definitions.</p><p>While k8s&rsquo;s default secret object is the preferred way to give containers our secrets, the object faces some challenges if you want to <em>gitops</em> your secrets.</p><p>The most obvious one is that your value you give the secret key is not encrypted in any way, just encoded with base64. The main purpose with this is that your value should not be readable to the naked eye. If we where to push your encoded secret to e.g github, your secret would then be exposed.</p><p>To solve this issue, we need to have a way of encrypting our secrets before we push it to our git and a way to make our continuous delivery too decrypt and deploy av secret to our Kubernetes clusters.</p><h2 id=why-sops>Why sops?</h2><p>Today we have multiple options for handling our secrets a secure way when they are consumed by our applications. To list a few:</p><ul><li><a href=https://github.com/mozilla/sops target=_blank rel="noopener noreffer">Mozilla Sops</a></li><li><a href=https://github.com/bitnami-labs/sealed-secrets target=_blank rel="noopener noreffer">SealedSecrets</a></li><li>HashCorp Vault</li><li>Cloud Providers&rsquo;s Vault/KMS with <a href=https://secrets-store-csi-driver.sigs.k8s.io/ target=_blank rel="noopener noreffer">CSI drivers</a></li></ul><p>The first two options is solely to solve the GitOps problem</p><p>Myself have worked with all the providers above and <code>sops</code> comes out to be the most simples one. Due to the fact that it is so easy to use, configure and integrates very well with FluxCD.</p><p>Sealed Secrets from Bitnami is also a great tool, but it&rsquo;s not as practical to work with if you compare it to <code>sops</code>.</p><p>I will not go into detail with the Vault&rsquo;s in this post, stay tuned for a separate posts about working with Vault&rsquo;s in Kubernetes ;)</p><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><code>Sops</code> is actually not a tool made for Kubernetes. It&rsquo;s an editor of encrypted files that supports YAML, JSON, ENV, INI and BINARY formats. It also has many integrations that it can encrypt with.</div></div></div><h2 id=prerequisites>Prerequisites</h2><p>You need access to a Kubernetes cluster with FluxCD thats already syncing configuration from a git repository.</p><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Note<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>ArgoCD does not have <code>sops</code> integration, yet. Hope they can come with trough with this soon as it would be nice to have the option to use it with Argo too. It&rsquo;s possible to use it with Argo, but it will require you to add all the dependencies to ArgoCD&rsquo;s container image. Which is a lot of hassle to maintain, due to the rapid development around this tool.</div></div></div><h2 id=installation>Installation</h2><p>Before we get all secure we need some tooling first.</p><p>Some distributions and OS&rsquo;s have these binaries in their package manager so check that out before you begin to download the binaries.</p><p>If you are running a Linux distribution you can use this short script:</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Make sure you are using the latest version and that you have <code>/usr/local/bin</code> in your path. Otherwise add it or change the destination of the binaries</div></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Bash data-lang=Bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># Install age and age-keygen</span>
</span></span><span class=line><span class=cl><span class=nv>AGE_VERSION</span><span class=o>=</span>v1.0.0
</span></span><span class=line><span class=cl>wget https://github.com/FiloSottile/age/releases/download/<span class=nv>$AGE_VERSION</span>/age-<span class=nv>$AGE_VERSION</span>-linux-amd64.tar.gz -O - <span class=p>|</span> tar -xz
</span></span><span class=line><span class=cl>chmod +x age/age* <span class=o>&amp;&amp;</span> sudo mv age/age* /usr/bin/.
</span></span><span class=line><span class=cl>rm -rf age
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Install sops</span>
</span></span><span class=line><span class=cl><span class=nv>SOPS_VERSION</span><span class=o>=</span>v3.7.3
</span></span><span class=line><span class=cl>wget https://github.com/mozilla/sops/releases/download/<span class=nv>$SOPS_VERSION</span>/sops-<span class=nv>$SOPS_VERSION</span>.linux.amd64 <span class=o>&amp;&amp;</span> chmod +x sops-<span class=nv>$SOPS_VERSION</span>.linux.amd64 <span class=o>&amp;&amp;</span> sudo mv sops-<span class=nv>$SOPS_VERSION</span>.linux.amd64 /usr/bin/sops</span></span></code></pre></td></tr></table></div></div><h2 id=why-age>Why Age</h2><p>FluxCD does support the following encryption tools</p><ul><li>GPG (GNU Privacy Guard)</li><li>OpenPGP</li><li>Age</li></ul><p>It also supports encryption with various cloud providers vault&rsquo;s and KMS&rsquo;s.</p><p>We will choose <code>age</code> for this scenario, because its simple, yet secure and modern.</p><h2 id=generating-the-private-key>Generating the private key</h2><p>Most of this is taken from the official <a href=https://fluxcd.io/docs/guides/mozilla-sops/ target=_blank rel="noopener noreffer">flux documentation</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>age-keygen -o age.agekey
</span></span><span class=line><span class=cl>Public key: age1qg2av8nvrnfywxz5j0hxqnvl6a4df73lcq4f48xdagj9qvsutvhq47awhv
</span></span></code></pre></td></tr></table></div></div><p><code>age-keygen</code> will automatically output the public key for us, we need this for later.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat age.agekey <span class=p>|</span>
</span></span><span class=line><span class=cl>kubectl create secret generic sops-age <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--namespace<span class=o>=</span>flux-system <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--from-file<span class=o>=</span>age.agekey<span class=o>=</span>/dev/stdin
</span></span></code></pre></td></tr></table></div></div><p>This will generate our first keypair and it will create a Kubernetes secret with our private key so that flux can access it.</p><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>Warning<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Create a secret with the age private key, the key name must end with .agekey to be detected as an age key</div></div></div><div class="details admonition Abstract open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>Important<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Remember to backup the <code>age.agekey</code> file to a secure secret store. If you need to recreate your clusters you need to have the private key available to be able to decrypt your secrets again.</div></div></div><h2 id=encrypt-your-secret-object>Encrypt your secret object</h2><p>Create your secret object:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k create secret generic mysecret -n myapp --from-literal<span class=o>=</span><span class=nv>dbpassword</span><span class=o>=</span>supersecret123 --dry-run<span class=o>=</span>client -o yaml &gt; mysecret.yaml
</span></span></code></pre></td></tr></table></div></div><p>Now let&rsquo;s take a look at our secret:</p><p><code>cat secret.yaml</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dbpassword</span><span class=p>:</span><span class=w> </span><span class=l>c3VwZXJzZWNyZXQxMjM=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Looks good.</p><p>Now we get to the exciting part, actually encrypting our value:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sops --age<span class=o>=</span>age1qg2av8nvrnfywxz5j0hxqnvl6a4df73lcq4f48xdagj9qvsutvhq47awhv --encrypt --encrypted-regex <span class=s1>&#39;^(data|dbpassword)$&#39;</span> --in-place mysecret.yaml
</span></span></code></pre></td></tr></table></div></div><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Tip<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>Pay attention to the <code>--encrypted-regex</code> parameter. Flux does not support encrypting the whole file, because then flux can not determine the object name, apiVersion etc&mldr; Therefore we can only encrypt the value of your key, which is a perfect way to do it, because it will make the file more readable.</div></div></div><p>Now lets look at our secret object:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat mysecret.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dbpassword</span><span class=p>:</span><span class=w> </span><span class=l>ENC[AES256_GCM,data:oNKIqI0jA4JjE24Y82JebXSuvHY=,iv:PguL7OGquRCGtnLvCK5TMGchCxWPPiIRI3kcJqY623g=,tag:demSCh7SqO/Y67mKifjKXA==,type:str]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysecret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>sops</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kms</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>gcp_kms</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>azure_kv</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hc_vault</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>age</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>recipient</span><span class=p>:</span><span class=w> </span><span class=l>age1qg2av8nvrnfywxz5j0hxqnvl6a4df73lcq4f48xdagj9qvsutvhq47awhv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>enc</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            -----BEGIN AGE ENCRYPTED FILE-----
</span></span></span><span class=line><span class=cl><span class=sd>            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBmNjB3ejVLUVNMLzErSm14
</span></span></span><span class=line><span class=cl><span class=sd>            YnhhamtDWGJMcDUrQTZOSVM2SzIvRUZiRmdBCjhDNHlKL3BiMEZZanNFZGVzckdx
</span></span></span><span class=line><span class=cl><span class=sd>            SUpUeU9SZzdxQXBnWGZtYmFYS1lUb1kKLS0tIHgyOXM2NGxLc1ZtUEhFRzdRN2VT
</span></span></span><span class=line><span class=cl><span class=sd>            K3E3dmpzazc2bFF3ekR6VGJsNHZVQ0UK4+MFB2HU1iYFpo15Zgid55HW9k9Wueko
</span></span></span><span class=line><span class=cl><span class=sd>            Y8D32VBFD8Tevx+ovXaQoHd6+ddFYLPSKTAdv6LMFt5ZV5z6VLAOjw==
</span></span></span><span class=line><span class=cl><span class=sd>            -----END AGE ENCRYPTED FILE-----</span><span class=w>            
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mac</span><span class=p>:</span><span class=w> </span><span class=l>ENC[AES256_GCM,data:zO7B0Ui8HKaLXXVU3EiL+K1a2AyXqAnpWiZVL91x7GWWHd/H5Ce/I0aF4pPkaxfoqLJecjhEp2SD57HyoyXRwKcyAWWdomEOT150yk5tx2YikKPGz/ed6QiZx+YzmJjzsHuKDicyqKP/ZgFzAQXxUpa58CJTQN+9E/NBuf1iePQ=,iv:dmUV4tN8y1zgvOchkfiyNNJ9ERF+N7XhX3Lj+KJkiC8=,tag:gFKiOfdqsxmE1eOz3OohJw==,type:str]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pgp</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>encrypted_regex</span><span class=p>:</span><span class=w> </span><span class=l>^(data|dbpassword)$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>3.7.2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Looks scary right? Do not worry, this is how it should look. This file is now safe to push to git and share with others.</p><h2 id=deploy-your-secret>Deploy your secret</h2><p>To deploy our secret we need to go trough flux, thats also means that we will need to push it to git. You also need to specify in the flux <code>Kustomization</code> which encryption method flux shall use.</p><p>Update or create your <code>Kustomization</code> with the <code>spec.decryption</code> parameter.
Here we specify our decryption provider and the secret with our private <code>age</code> key.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kustomize.toolkit.fluxcd.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Kustomization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flux-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>1m0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./test/myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prune</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sourceRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>GitRepository</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flux-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>decryption</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>sops</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sops-age</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>With this configuration in place, flux will decrypt and deploy your secret to your targeted Kubernetes cluster.
To verify, make sure your <code>Kustomization</code> has synced and take a look at your secret inside Kubernetes</p><h2 id=decrypt-and-edit-your-secret-on-the-fly-for-debugging>Decrypt and edit your secret on the fly for debugging</h2><p>This is one of the main reasons i like <code>sops</code> better than <code>Sealed Secrets</code>. You can decrypt yor secret locally with just doing:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sops mysecret.yaml
</span></span></code></pre></td></tr></table></div></div><p>This helps a lot with debugging etc. Anyone with access to the private key can decrypt the secret object you have stored in git.</p><h2 id=encrypt-a-secret-object-with-multiple-keys>Encrypt a secret object with multiple keys</h2><p>The easiest way to encrypt a secret object with multiple keys is just to add another <code>--encrypted-regex</code> parameter when you&rsquo;re encrypting.</p><h2 id=age-and-sops-configuration>Age and Sops configuration</h2><h3 id=age>Age</h3><p>Your private keys must be stored in <code>~/.config/sops/age/keys.txt</code> when working with <code>sops</code>, you can also specify your own path with <code>export SOPS_AGE_KEY_FILE=/my/secret/path</code>. You can have multiple keypairs stored in that single file. <code>Sops</code> will know which private key to use when you run <code>sops</code> against a encrypted file, because the public key is annotated in all encrypted secret object&rsquo;s.</p><h3 id=sops>Sops</h3><p>When decrypting you really don&rsquo;t want to find which public key you want to decrypt with every time, if you manage multiple pairs, which is recommended. To make this easier, create a <code>sops</code> config file:</p><p>This file should be created in the root of you git directory.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>creation_rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>path_regex</span><span class=p>:</span><span class=w> </span><span class=l>^test\/.*\.yaml$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class=l>publickey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>path_regex</span><span class=p>:</span><span class=w> </span><span class=l>^qa\/.*\.yaml$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class=l>publickey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>path_regex</span><span class=p>:</span><span class=w> </span><span class=l>^prod\/.*\.yaml$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>age</span><span class=p>:</span><span class=w> </span><span class=l>publickey</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>This example will select the targeted keypair based on which folder you are standing in when running <code>sops --encrypt</code></p><h2 id=useful-commands-and-tips>Useful commands and tips</h2><ul><li><code>cat</code> your secret<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sops -d mysecret.yaml
</span></span></code></pre></td></tr></table></div></div></li><li>If you want do decrypt your secret <em>and</em> test/verify it against the cluster at the same time:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sops -d mysecret.yaml <span class=p>|</span> k diff -f -
</span></span></code></pre></td></tr></table></div></div></li><li>You can edit your secret after it has been encrypted, at least the <em>non encrypted</em> part of it. To do this you need to open the file with <code>sops</code> not a normal text editor e.g <code>vim</code>.<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sops mysecret.yaml
</span></span><span class=line><span class=cl><span class=c1># Edit your file and save</span>
</span></span></code></pre></td></tr></table></div></div></li><li>Send encrypted file to new file<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sops -e test.yaml &gt; encryptedTest.yaml
</span></span></code></pre></td></tr></table></div></div></li></ul><h2 id=verdict>Verdict</h2><p>All in all, a very good, secure and simple to use tool for <em>storing</em> your secrets in git.</p><h3 id=the-good>The good</h3><ul><li>Simple to use and install</li><li>Secure</li><li>Very easy to work with and maintain</li><li>Good Flux integration</li><li>Perfect for if you need to recover your secrets when you are recreating your clusters, which is a common disaster recovery strategy when working with Kubernetes and stateless platforms</li><li>Supports the GitOps model</li></ul><h3 id=the-_not_-so-good>The <em>not</em> so good</h3><ul><li>The private keys are still stored as base64 encoded Kubernetes secrets. You will need to lock this down with RBAC<ul><li>An alternative integration with a Vault will solve this to some extend.</li></ul></li><li>No support <em>yet</em> for usage with ArgoCD</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 15-05-2022</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://localhost/sops/ data-title="Encrypt your Kubernetes secrets with Sops, FluxCD and age" data-hashtags="Open Source,Secret Management,GitOps,Kubernetes"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=http://localhost/sops/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://localhost/sops/ data-title="Encrypt your Kubernetes secrets with Sops, FluxCD and age"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/open-source/>Open Source</a>,&nbsp;<a href=/tags/secret-management/>Secret Management</a>,&nbsp;<a href=/tags/gitops/>GitOps</a>,&nbsp;<a href=/tags/kubernetes/>Kubernetes</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://blog.loholt.io target=_blank>Andreas Loholt</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/index.umd.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},cookieconsent:{content:{dismiss:"Got it!",link:"Learn more",message:"This website uses Cookies to improve your experience."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"id-1":"blog.loholt.io","id-2":"blog.loholt.io"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30},typeit:{cursorChar:"|",cursorSpeed:1e4,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:-1,speed:70}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-K43NGWG8SP",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-K43NGWG8SP" async></script></body></html>